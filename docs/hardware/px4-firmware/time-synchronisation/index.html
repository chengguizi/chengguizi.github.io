<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="generator" content="Docusaurus v2.0.0-alpha.61">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous"><title data-react-helmet="true">time-synchronisation | My Logs</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:title" content="time-synchronisation | My Logs"><meta data-react-helmet="true" name="description" content="FCU-OBC Time Synchronisation"><meta data-react-helmet="true" property="og:description" content="FCU-OBC Time Synchronisation"><meta data-react-helmet="true" property="og:url" content="https://chengguizi.github.io/docs/hardware/px4-firmware/time-synchronisation"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://chengguizi.github.io/docs/hardware/px4-firmware/time-synchronisation"><link rel="stylesheet" href="/styles.ef3fd247.css">
<link rel="preload" href="/styles.0a4195cd.js" as="script">
<link rel="preload" href="/runtime~main.0a9401a8.js" as="script">
<link rel="preload" href="/main.cb1cffdb.js" as="script">
<link rel="preload" href="/1.2d582883.js" as="script">
<link rel="preload" href="/2.2b91fbf4.js" as="script">
<link rel="preload" href="/3.88e3f531.js" as="script">
<link rel="preload" href="/1be78505.bf6c8ae5.js" as="script">
<link rel="preload" href="/85.4ee87964.js" as="script">
<link rel="preload" href="/20ac7829.db7920b3.js" as="script">
<link rel="preload" href="/17896441.00fe9e28.js" as="script">
<link rel="preload" href="/638df40c.2d60fd3c.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav class="navbar navbar--light navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img class="navbar__logo" src="/img/logo.svg" alt="My Site Logo"><strong class="navbar__title">My Logs</strong></a><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/hardware/">Hardware</a><ul class="dropdown__menu"><li><a class="dropdown__link" position="left" href="/docs/hardware/jetson/flash-existing-image">Jetson TX2</a></li><li><a class="dropdown__link" position="left" href="/docs/hardware/cameras/tiscamera-install">Cameras</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" position="left" href="/docs/hardware/px4-firmware/time-synchronisation">PX4 Firmware</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link" href="/docs/systems/vicon">Systems</a><ul class="dropdown__menu"><li><a class="dropdown__link" position="left" href="/docs/systems/ddrone_v2/ddrone">Ddrone V2</a></li><li><a class="dropdown__link" position="left" href="/docs/systems/unity-SITL">Simulations</a></li><li><a class="dropdown__link" position="left" href="/docs/systems/vicon">Vicon</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link" href="/docs/linux/desktop/gnome-shell-extensions">Linux</a><ul class="dropdown__menu"><li><a class="dropdown__link" position="left" href="/docs/linux/desktop/gnome-shell-extensions">Desktop</a></li><li><a class="dropdown__link" position="left" href="/docs/linux/packages/file-systems">Software Packages</a></li><li><a class="dropdown__link" position="left" href="/docs/linux/ros/using-catkin-build">ROS</a></li><li><a class="dropdown__link" position="left" href="/docs/linux/kernel/grub-default-kernel">Drivers &amp; Kernel</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link" href="/docs/productivity/git/git">Productivity</a><ul class="dropdown__menu"><li><a class="dropdown__link" position="left" href="/docs/productivity/git/git">Git Version Control</a></li><li><a class="dropdown__link" position="left" href="/docs/productivity/cmake_debug/cmake">CMake and Debugging</a></li><li><a class="dropdown__link" position="left" href="/docs/productivity/uiux/pangolin">UI/UX Tools</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link" href="/docs/research/">Research</a><ul class="dropdown__menu"><li><a class="dropdown__link" position="left" href="/docs/research/calibration/index">Sensor Calibration</a></li><li><a class="dropdown__link" position="left" href="/docs/research/vio/basalt-backend">VIO</a></li></ul></div><a class="navbar__item navbar__link" href="/docs/examples/doc1">Examples</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/chengguizi/chengguizi.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2aTZ"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_BsTx">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_BsTx">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img class="navbar__logo" src="/img/logo.svg" alt="My Site Logo"><strong class="navbar__title">My Logs</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--sublist navbar__link--active" href="/docs/hardware/">Hardware</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" position="left" href="/docs/hardware/jetson/flash-existing-image">Jetson TX2</a></li><li class="menu__list-item"><a class="menu__link" position="left" href="/docs/hardware/cameras/tiscamera-install">Cameras</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active" position="left" href="/docs/hardware/px4-firmware/time-synchronisation">PX4 Firmware</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist" href="/docs/systems/vicon">Systems</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" position="left" href="/docs/systems/ddrone_v2/ddrone">Ddrone V2</a></li><li class="menu__list-item"><a class="menu__link" position="left" href="/docs/systems/unity-SITL">Simulations</a></li><li class="menu__list-item"><a class="menu__link" position="left" href="/docs/systems/vicon">Vicon</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist" href="/docs/linux/desktop/gnome-shell-extensions">Linux</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" position="left" href="/docs/linux/desktop/gnome-shell-extensions">Desktop</a></li><li class="menu__list-item"><a class="menu__link" position="left" href="/docs/linux/packages/file-systems">Software Packages</a></li><li class="menu__list-item"><a class="menu__link" position="left" href="/docs/linux/ros/using-catkin-build">ROS</a></li><li class="menu__list-item"><a class="menu__link" position="left" href="/docs/linux/kernel/grub-default-kernel">Drivers &amp; Kernel</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist" href="/docs/productivity/git/git">Productivity</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" position="left" href="/docs/productivity/git/git">Git Version Control</a></li><li class="menu__list-item"><a class="menu__link" position="left" href="/docs/productivity/cmake_debug/cmake">CMake and Debugging</a></li><li class="menu__list-item"><a class="menu__link" position="left" href="/docs/productivity/uiux/pangolin">UI/UX Tools</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist" href="/docs/research/">Research</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" position="left" href="/docs/research/calibration/index">Sensor Calibration</a></li><li class="menu__list-item"><a class="menu__link" position="left" href="/docs/research/vio/basalt-backend">VIO</a></li></ul></li><li class="menu__list-item"><a class="menu__link" href="/docs/examples/doc1">Examples</a></li><li class="menu__list-item"><a class="menu__link" href="/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/chengguizi/chengguizi.github.io" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_2gpo"><div class="docSidebarContainer_3_JD" role="complementary"><div class="sidebar_2urC"><div class="menu menu--responsive menu_5FrY"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_Dm3K" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">PX4 Firmware</a><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/hardware/px4-firmware/time-synchronisation">Time Synchronisation</a></li></ul></li></ul></div></div></div><main class="docMainContainer_3EyW"><div class="container padding-vert--lg docItemWrapper_1EkI"><div class="row"><div class="col docItemCol_2ASc"><div class="docItemContainer_3QWW"><article><div class="markdown"><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="fcu-obc-time-synchronisation"></a>FCU-OBC Time Synchronisation<a aria-hidden="true" tabindex="-1" class="hash-link" href="#fcu-obc-time-synchronisation" title="Direct link to heading">#</a></h1><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="motivation---sensor-data-correspondence"></a>Motivation - Sensor Data Correspondence<a aria-hidden="true" tabindex="-1" class="hash-link" href="#motivation---sensor-data-correspondence" title="Direct link to heading">#</a></h2><p>PX4-based flight controller boards (FCU), such as Pixhawk series, have rich I/O interfaces, and at the same time provides a real-time operating system environment (POSIX-compliant Nuttx specifically). These capabilities enables us to have real-time guarantees, when interfacing any sensors that are time-critical.</p><p>The necessity of time synchronisation comes into play due to the following facts:</p><ol><li>The flight controller board (FCU) and the on-board computer (OBC) operates on different hardware clocks (typically its respective boot time, in nanoseconds);</li><li>Sensor data reception is physically distributed: some sensor data (e.g. built-in IMU) is received by the FCU, while others (e.g. cameras) are received by the OBC;</li><li>Tight-coupled sensor fusion algorithm requires precise time correspondence of all sensor inputs involved, to perform inference on the state of the agent.</li></ol><p>One particular use case is to operate multiple cameras in a hardware-synchronised fashion, with a master IMU module sending electrical triggering signal. We are interested in determining the correspondence between all incoming image streams and the triggering IMU measurement.</p><p>The solution is non-trivial as IMU measurement is taken with a timestamp in <strong>FCU-time domain</strong>, whereas the image reception (either over MIPI or USB data link) is timestamped in <strong>OBC-time domain</strong>.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="doing-without-time-synchronisation"></a>Doing Without Time Synchronisation<a aria-hidden="true" tabindex="-1" class="hash-link" href="#doing-without-time-synchronisation" title="Direct link to heading">#</a></h2><p>It is technically possible to determine correspondence without any time synchronisation, but with a few necessary assumptions. In this setting, we need to assume:</p><ul><li>All sensor data to establish correspondence are strictly triggered by the same physical event (CPU instruction, electrical signal), up to the precision required (often sub-millisecond);</li><li>The communication delays of respective sensor data <strong>to OBC</strong> are predicable / consistent;</li><li>The sensor data is gathered by OBC, and the sensor fusion algorithms are only carried out on OBC. In this way, we could perform all processing in <strong>OBC-time domain</strong>;</li><li>The OBC has close to realtime scheduling performance. (This is where things may break, particularly under high CPU load)</li></ul><p>Fortunately, this is often the case. Lets do some quick maths in the case of IMU-Cameras data correspondence.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="the-good-stuff"></a>The Good Stuff<a aria-hidden="true" tabindex="-1" class="hash-link" href="#the-good-stuff" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="latency-for-imu-data-over-uart"></a>Latency for IMU Data over UART<a aria-hidden="true" tabindex="-1" class="hash-link" href="#latency-for-imu-data-over-uart" title="Direct link to heading">#</a></h4><p>Typically, IMU data is transmitted over UART protocol from FCU / dedicated IMU to the OBC. The typical baud rate we have is 921600bps, which is ~90KB per second, which in turn is <strong>90 byte per millisecond</strong>. It is typically safe to assume each IMU packet is less than a 100 byte, therefore the communication delay induced by the physical UART layer is about <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>t</mi><mrow><mi>U</mi><mi>A</mi><mi>R</mi><mi>T</mi></mrow></msub><mo>â‰ˆ</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">t_{UART} \approx 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76508em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em">U</span><span class="mord mathnormal mtight">A</span><span class="mord mathnormal mtight" style="margin-right:0.00773em">R</span><span class="mord mathnormal mtight" style="margin-right:0.13889em">T</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em"></span><span class="mrel">â‰ˆ</span><span class="mspace" style="margin-right:0.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em"></span><span class="mord">1</span></span></span></span></span> ms. In reality, this number is still in the range of very few milliseconds (depending on the pulling rate of the OS; In Linux low-latency mode, the rate is about 1ms).</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="latency-for-image-data-over-usb30"></a>Latency for Image Data over USB3.0<a aria-hidden="true" tabindex="-1" class="hash-link" href="#latency-for-image-data-over-usb30" title="Direct link to heading">#</a></h4><p>On the other hand, one image data frame is much much larger than an imu data frame. A 1-megapixel 16-bit raw image would give rise to a data size of 2MB. Provided a USB3.0 physical layer connection has a bandwidth of 5Gbit/s, the communication delay over USB is <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>t</mi><mrow><mi>U</mi><mi>S</mi><mi>B</mi></mrow></msub><mo>â‰ˆ</mo><mfrac><mrow><mn>8</mn><mo>âˆ—</mo><mn>2</mn></mrow><mn>5</mn></mfrac><mo>=</mo><mn>3.4</mn></mrow><annotation encoding="application/x-tex">t_{USB} \approx \frac{8*2}{5} = 3.4</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76508em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em">U</span><span class="mord mathnormal mtight" style="margin-right:0.05764em">S</span><span class="mord mathnormal mtight" style="margin-right:0.05017em">B</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em"></span><span class="mrel">â‰ˆ</span><span class="mspace" style="margin-right:0.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:1.190108em;vertical-align:-0.345em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em"><span style="top:-2.6550000000000002em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">5</span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.394em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">8</span><span class="mbin mtight">âˆ—</span><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em"></span><span class="mord">3</span><span class="mord">.</span><span class="mord">4</span></span></span></span></span> ms. In reality, the delay could be in terms of <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>10</mn></mrow><annotation encoding="application/x-tex">10</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em"></span><span class="mord">1</span><span class="mord">0</span></span></span></span></span> ms or more, heavily <strong>depends on how many devices</strong> present on the USB bus streaming.</p><p>Putting into context, with a 20Hz rate of IMU-cameras correspondence frequency, the data correspondence happens every 50ms or so. Therefore, we could infer the IMU-cameras correspondence by just looking at the time of arrival (TOA) at OBC side. Why is that the case?</p><ol><li>Camera data is almost surely (we will see when this is not the case soon) arrived after IMU data, because of the communication delays;</li><li>Compared to the 50ms sampling period in between each IMU-camera correspondence event, the expected slack time between the TOA of camera data and TOA of IMU data is much less, <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>10</mn><mi>m</mi><mi>s</mi><mo>&lt;</mo><mn>50</mn><mi>m</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">10ms &lt; 50ms</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68354em;vertical-align:-0.0391em"></span><span class="mord">1</span><span class="mord">0</span><span class="mord mathnormal">m</span><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2777777777777778em"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em"></span><span class="mord">5</span><span class="mord">0</span><span class="mord mathnormal">m</span><span class="mord mathnormal">s</span></span></span></span></span>. This ensures that we do not have ambiguity of having camera data &#x27;diffusing&#x27; into the next IMU-camera event. (We may term this as <strong>aliasing</strong>)</li></ol><p>In summary, the good stuff here is that we have the <strong>slack time</strong> (between IMU data and camera data) predicable and less than the <strong>sampling period</strong>. We could use a trivial algorithm to match the camera data to the closest IMU data which is <em>strictly earlier</em> in OBC-time domain.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="the-big-but"></a>The Big But...<a aria-hidden="true" tabindex="-1" class="hash-link" href="#the-big-but" title="Direct link to heading">#</a></h3><p>Now it&#x27;s a good time to reflect the current approach:</p><p><strong>Pros</strong>:</p><ul><li>No software architectural dependency outside OBC</li></ul><p><strong>Cons</strong>:</p><ul><li>Case-by-case analysis</li><li>Non-realtime operating system</li><li>Subject to system CPU loading and other resource constraints</li></ul><p>The obvious advantage of this no-synchornisation approach is that there is no dependency outside the OBC, as we disregard all other time domains, and only work on time of arrival timings in the OBC-time domain.</p><p>However, as we have seen, the correctness of such approach need to be analysed case-by-case: the nature of the communication channels, the data size, the time period of each correspondence event. All those piece must be compatible to make inference of correspondance work. Otherwise, issues like aliasing may happen.</p><p><strong>Known issue</strong>: In not-so rare cases, camera data may arrive to OBC earlier than the triggering. This may caused by multiple factors, such as the USB kernel was allocated the right time to transmit the data over, while the UART kernel is stucked waiting for scheduling. I would like to term this effect as <strong>jitter</strong>, as this normally have something to do on how the OS schedule kernel tasks.</p><p>For a reference on how the implementation may look like for a IMU-Camera synchronisation, refer here <a href="https://github.com/chengguizi/tiscamera_ros/blob/master/include/camera_imu_sync.hpp" target="_blank" rel="noopener noreferrer">camera_imu_sync.cpp</a>.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="doing-time-synchronisation-using-mavlink"></a>Doing Time Synchronisation using MAVLink<a aria-hidden="true" tabindex="-1" class="hash-link" href="#doing-time-synchronisation-using-mavlink" title="Direct link to heading">#</a></h2><p> The more elaborated and proper way to achieve time synchronisation of different sensor data in different time-domain is discussed below.</p><p>In the platform we used, an implementation has been done using MAVLink protocol, implemented in both PX4 Firmware and Mavros package.</p><p><strong>Working Principle</strong> (<a href="https://github.com/mavlink/mavlink-devguide/issues/194" target="_blank" rel="noopener noreferrer">Reference</a>)</p><p>The host (both side CAN be the host at the SAME time) sends a <a href="https://mavlink.io/en/messages/common.html#TIMESYNC" target="_blank" rel="noopener noreferrer">TIMESYNC message</a>, which contain two fields <code>tc1</code> (filled with zero) and <code>ts1</code>(filled with current hardware time in nanoseconds). </p><p>As the receiver, when a TIMESYNC message is received, there are two cases:</p><ul><li><code>tc1</code> == 0, then the message just make a half-round trip. The receiver sends back <code>tc1</code> filled with its own current hardware timestamp in nanoseconds, and the original <code>ts1</code> field</li><li><code>tc1</code> != 0, then the message has made the full round trip. Then the current hardware time subtracted by the <code>ts1</code> field will give the round trip time, and tc1 - (current time + <code>ts1</code>) / 2 will give the offset.</li></ul></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/chengguizi/chengguizi.github.io/docs/hardware/px4-firmware/time-synchronisation.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 40 40" style="margin-right:0.3em;vertical-align:sub"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col text--right"><em><small>Last updated on <time datetime="2020-08-19T09:36:16.000Z" class="docLastUpdatedAt_217_">8/19/2020</time></small></em></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_3klQ"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#motivation---sensor-data-correspondence" class="table-of-contents__link">Motivation - Sensor Data Correspondence</a></li><li><a href="#doing-without-time-synchronisation" class="table-of-contents__link">Doing Without Time Synchronisation</a><ul><li><a href="#the-good-stuff" class="table-of-contents__link">The Good Stuff</a></li><li><a href="#the-big-but" class="table-of-contents__link">The Big But...</a></li></ul></li><li><a href="#doing-time-synchronisation-using-mavlink" class="table-of-contents__link">Doing Time Synchronisation using MAVLink</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/doc1">Style Guide</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/doc2">Second Doc</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow</a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord</a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="text--center"><div>Copyright Â© 2020 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/styles.0a4195cd.js"></script>
<script src="/runtime~main.0a9401a8.js"></script>
<script src="/main.cb1cffdb.js"></script>
<script src="/1.2d582883.js"></script>
<script src="/2.2b91fbf4.js"></script>
<script src="/3.88e3f531.js"></script>
<script src="/1be78505.bf6c8ae5.js"></script>
<script src="/85.4ee87964.js"></script>
<script src="/20ac7829.db7920b3.js"></script>
<script src="/17896441.00fe9e28.js"></script>
<script src="/638df40c.2d60fd3c.js"></script>
</body>
</html>