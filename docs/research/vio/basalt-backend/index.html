<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="generator" content="Docusaurus v2.0.0-alpha.61">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous"><title data-react-helmet="true">basalt-backend | My Logs</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:title" content="basalt-backend | My Logs"><meta data-react-helmet="true" name="description" content="Basalt Backend Walkthrough"><meta data-react-helmet="true" property="og:description" content="Basalt Backend Walkthrough"><meta data-react-helmet="true" property="og:url" content="https://chengguizi.github.io/docs/research/vio/basalt-backend"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://chengguizi.github.io/docs/research/vio/basalt-backend"><link rel="stylesheet" href="/styles.ef3fd247.css">
<link rel="preload" href="/styles.0a4195cd.js" as="script">
<link rel="preload" href="/runtime~main.0a9401a8.js" as="script">
<link rel="preload" href="/main.cb1cffdb.js" as="script">
<link rel="preload" href="/1.2d582883.js" as="script">
<link rel="preload" href="/2.2b91fbf4.js" as="script">
<link rel="preload" href="/3.88e3f531.js" as="script">
<link rel="preload" href="/1be78505.bf6c8ae5.js" as="script">
<link rel="preload" href="/85.4ee87964.js" as="script">
<link rel="preload" href="/20ac7829.db7920b3.js" as="script">
<link rel="preload" href="/17896441.00fe9e28.js" as="script">
<link rel="preload" href="/c6753341.3e205817.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav class="navbar navbar--light navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img class="navbar__logo" src="/img/logo.svg" alt="My Site Logo"><strong class="navbar__title">My Logs</strong></a><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link" href="/docs/hardware/">Hardware</a><ul class="dropdown__menu"><li><a class="dropdown__link" position="left" href="/docs/hardware/jetson/flash-existing-image">Jetson TX2</a></li><li><a class="dropdown__link" position="left" href="/docs/hardware/cameras/tiscamera-install">Cameras</a></li><li><a class="dropdown__link" position="left" href="/docs/hardware/px4-firmware/time-synchronisation">PX4 Firmware</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link" href="/docs/systems/vicon">Systems</a><ul class="dropdown__menu"><li><a class="dropdown__link" position="left" href="/docs/systems/ddrone_v2/ddrone">Ddrone V2</a></li><li><a class="dropdown__link" position="left" href="/docs/systems/unity-SITL">Simulations</a></li><li><a class="dropdown__link" position="left" href="/docs/systems/vicon">Vicon</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link" href="/docs/linux/desktop/gnome-shell-extensions">Linux</a><ul class="dropdown__menu"><li><a class="dropdown__link" position="left" href="/docs/linux/desktop/gnome-shell-extensions">Desktop</a></li><li><a class="dropdown__link" position="left" href="/docs/linux/packages/file-systems">Software Packages</a></li><li><a class="dropdown__link" position="left" href="/docs/linux/ros/using-catkin-build">ROS</a></li><li><a class="dropdown__link" position="left" href="/docs/linux/kernel/grub-default-kernel">Drivers &amp; Kernel</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link" href="/docs/productivity/git/git">Productivity</a><ul class="dropdown__menu"><li><a class="dropdown__link" position="left" href="/docs/productivity/git/git">Git Version Control</a></li><li><a class="dropdown__link" position="left" href="/docs/productivity/cmake_debug/cmake">CMake and Debugging</a></li><li><a class="dropdown__link" position="left" href="/docs/productivity/uiux/pangolin">UI/UX Tools</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/research/">Research</a><ul class="dropdown__menu"><li><a class="dropdown__link" position="left" href="/docs/research/calibration/index">Sensor Calibration</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" position="left" href="/docs/research/vio/basalt-backend">VIO</a></li></ul></div><a class="navbar__item navbar__link" href="/docs/examples/doc1">Examples</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/chengguizi/chengguizi.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2aTZ"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_BsTx">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_BsTx">🌞</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img class="navbar__logo" src="/img/logo.svg" alt="My Site Logo"><strong class="navbar__title">My Logs</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link menu__link--sublist" href="/docs/hardware/">Hardware</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" position="left" href="/docs/hardware/jetson/flash-existing-image">Jetson TX2</a></li><li class="menu__list-item"><a class="menu__link" position="left" href="/docs/hardware/cameras/tiscamera-install">Cameras</a></li><li class="menu__list-item"><a class="menu__link" position="left" href="/docs/hardware/px4-firmware/time-synchronisation">PX4 Firmware</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist" href="/docs/systems/vicon">Systems</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" position="left" href="/docs/systems/ddrone_v2/ddrone">Ddrone V2</a></li><li class="menu__list-item"><a class="menu__link" position="left" href="/docs/systems/unity-SITL">Simulations</a></li><li class="menu__list-item"><a class="menu__link" position="left" href="/docs/systems/vicon">Vicon</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist" href="/docs/linux/desktop/gnome-shell-extensions">Linux</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" position="left" href="/docs/linux/desktop/gnome-shell-extensions">Desktop</a></li><li class="menu__list-item"><a class="menu__link" position="left" href="/docs/linux/packages/file-systems">Software Packages</a></li><li class="menu__list-item"><a class="menu__link" position="left" href="/docs/linux/ros/using-catkin-build">ROS</a></li><li class="menu__list-item"><a class="menu__link" position="left" href="/docs/linux/kernel/grub-default-kernel">Drivers &amp; Kernel</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist" href="/docs/productivity/git/git">Productivity</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" position="left" href="/docs/productivity/git/git">Git Version Control</a></li><li class="menu__list-item"><a class="menu__link" position="left" href="/docs/productivity/cmake_debug/cmake">CMake and Debugging</a></li><li class="menu__list-item"><a class="menu__link" position="left" href="/docs/productivity/uiux/pangolin">UI/UX Tools</a></li></ul></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--sublist navbar__link--active" href="/docs/research/">Research</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" position="left" href="/docs/research/calibration/index">Sensor Calibration</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active" position="left" href="/docs/research/vio/basalt-backend">VIO</a></li></ul></li><li class="menu__list-item"><a class="menu__link" href="/docs/examples/doc1">Examples</a></li><li class="menu__list-item"><a class="menu__link" href="/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/chengguizi/chengguizi.github.io" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_2gpo"><div class="docSidebarContainer_3_JD" role="complementary"><div class="sidebar_2urC"><div class="menu menu--responsive menu_5FrY"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_Dm3K" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Camera Calibration</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/research/calibration/index">Getting Started with Kalibr</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/research/calibration/using-kalibr-calibration">Multi-Camera Calibration</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/research/calibration/verify-calibration">Verify Calibration Results</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">VIO</a><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/research/vio/basalt-backend">Basalt Backend (vioestimator)</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/research/vio/basalt-frontend">Basalt Frontend (optical-flow)</a></li></ul></li></ul></div></div></div><main class="docMainContainer_3EyW"><div class="container padding-vert--lg docItemWrapper_1EkI"><div class="row"><div class="col docItemCol_2ASc"><div class="docItemContainer_3QWW"><article><div class="markdown"><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="basalt-backend-walkthrough"></a>Basalt Backend Walkthrough<a aria-hidden="true" tabindex="-1" class="hash-link" href="#basalt-backend-walkthrough" title="Direct link to heading">#</a></h1><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="overview--class-names"></a>Overview &amp; Class Names<a aria-hidden="true" tabindex="-1" class="hash-link" href="#overview--class-names" title="Direct link to heading">#</a></h2><p>The backend of the VIO framework is contained with the base class <code>VioEstimatorBase</code> (defined in <code>vio_estimator.h</code>) which is the parent class of two type of the estimator possible:</p><ul><li><code>KeypointVioEstimator</code>(defined in <code>keypoint_vio.h</code>), and</li><li><code>KeypointVoEstimator</code>(defined in <code>keypoint_vo.h</code>)</li></ul><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-cpp codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// how the factory class initialise to different type of estimator depends on use_imu variable</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">VioEstimatorBase</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">Ptr VioEstimatorFactory</span><span class="token operator" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">getVioEstimator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> VioConfig</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> Calibration</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">double</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> cam</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> Eigen</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">Vector3d</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> g</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">bool</span><span class="token plain"> use_imu</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  VioEstimatorBase</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">Ptr res</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">use_imu</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    res</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">reset</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">KeypointVioEstimator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">g</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cam</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    res</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">reset</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">KeypointVoEstimator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cam</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> res</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></div></div></div></div></div><p>For the purpose of this walkthrough honly <code>KeypointVioEstimator</code> is conerned. We are interested in understanding how optical flow observations (keypoints) are used to form keyframes, and 3D landmarks.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="io-of-base-class-of-vioestimator"></a>I/O of Base Class of VioEstimator<a aria-hidden="true" tabindex="-1" class="hash-link" href="#io-of-base-class-of-vioestimator" title="Direct link to heading">#</a></h2><p>The <strong>inputs</strong> are optical results (observations of keypoints) and imu inputs:</p><ol><li>A TBB queue, <code>vision_data_queue</code> of type <code>OpticalFlowResult::Ptr</code>, where each optical flow result contains <ol><li>the 64-bit timestamp,</li><li>a vector named <code>observations</code>, containing a map between the keypoint ID <code>KeypointId</code>  and its 2D transformations <code>Eigen::AffineCompact2f</code> (2D transformation literally represent the keypoint 2D location in the observing camera frame, aka. the uv coordinates)</li><li>and a pointer to the original image data (<code>std::vector&lt;ImageData&gt;</code>), for the current frame</li></ol></li><li>A TBB queue, <code>imu_data_queue</code> of type <code>ImuData::Ptr</code>, storing the timestamp, and the accelerometer and gyroscope information</li></ol><p>The <strong>outputs</strong> are output states, ⚠️ marginalised data?, and vio visualisation data:</p><ol><li>A pointer to TBB queue <code>out_state_queue</code> of type <code>PoseVelBiasState::Ptr</code> containing all the states which are: <code>t_ns</code> timestamp of the state in nanoseconds; <code>T_w_i</code> pose of the state; <code>vel_w_i</code> linear velocity of the state; <code>bias_gyro</code> gyroscope bias; <code>bias_accel  </code>accelerometer bias.</li><li>A pointer to TBB queue <code>out_marg_queue</code> of type <code>MargData::Ptr</code></li><li>A pointer to TBB queue<code>out_vis_queue</code> of type <code>VioVisualizationData::Ptr</code></li></ol><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="initialisation"></a>Initialisation<a aria-hidden="true" tabindex="-1" class="hash-link" href="#initialisation" title="Direct link to heading">#</a></h2><p>With the incoming flow of visual optical flow observations and IMU data, the backend has a way to initialise itself with a proper initial pose (and velocity) and bias estimate. We can choose to initialise either just the biases and attitude (quaternion), or with the transformation and velocity as well.</p><p><strong>Key things to note:</strong></p><ul><li>The current implementation in Basalt only does bias and quaternion initialisation (all others set): bias is <u>set them to zero</u>, and attitude is done by two-vector calculation from single data point of imu -&gt; <strong>TODO [Improvement]</strong></li><li>The initial IMU-world transformation <code>T_w_i_init</code> has a very special way to initialise, which is yaw ignorant:<ul><li>First the accelerometer raw reading is used (one data point), it is assumed to be the gravity vector</li><li>The gravity vector is rotated to be aligned with the positive Z axis, this rotation action is recorded as a quaternion. This quaternion is essentially performing basis changing from body frame to global frame.</li><li>That is to say, the transformation is only defined by the plane that the gravity vector and the +ve z-axis make as well as the angle itself. This does not take account into the correct yaw, a.k.a the initial heading is not consistent, which is a function of how the IMU is mounted and its initial orientation.</li><li><strong>NOTE</strong>: Therefore, with a fixed mounting between the IMU and camera, and with a fixed up direction of the whole rig (e.g. the drone), we can pre-calculate the rotation matrix to make the initialised <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi></mrow><annotation encoding="application/x-tex">T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em"></span><span class="mord mathnormal" style="margin-right:0.13889em">T</span></span></span></span></span> transformation matrix to face our desired coordinate convention (e.g. NWU).</li></ul></li><li>The pre-integration buffer <code>imu_meas</code> is also initialised here, taken account of the bias (which is always set to zeros in the implementation)</li><li>The bundle adjustment states <code>frame_states</code> of type <code> Eigen::aligned_map&lt;int64_t, PoseVelBiasStateWithLin&gt;</code></li><li><code>marg_order</code>??</li><li>The processing thread is created within the <code>initialize()</code> function, which is basically a <strong>while</strong> loop, by the means of lamda function and <code>std::thread</code>.</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="the-processing-thread-within-keypointvioestimator"></a>The Processing Thread (within <code>KeypointVioEstimator</code>)<a aria-hidden="true" tabindex="-1" class="hash-link" href="#the-processing-thread-within-keypointvioestimator" title="Direct link to heading">#</a></h2><p><strong>Configs</strong>:</p><ul><li><p><code>vio_enforce_realtime</code> is used to set when the backend cannot catch up with optical flow results. It will throw away all previous results, except the latest one in the queue.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-cpp codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">vio_enforce_realtime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// drop current frame if another frame is already in the queue.</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">vision_data_queue</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">try_pop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">curr_frame</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">skipped_image</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">skipped_image</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">          std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">cerr</span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;[Warning] skipped opt flow size: &quot;</span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain">skipped_image</span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain">std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">endl</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">curr_frame</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span></div></div></div></div></div></li></ul><ul><li><p><code>vio_min_triangulation_dist</code> is used to determine whether the two camera frames are suitable for triangulation in generating the landmarks, during a keyframe initialisation</p></li><li><p><code>vio_new_kf_keypoints_thresh</code> is the threshold for the ratio between tracked landmarks and total tracked keypoints (e.g. raito of 0.7)</p></li><li><p><code>vio_min_frames_after_kf</code> </p></li></ul><p><strong>Calibs</strong>:</p><ul><li><p><code>cam_time_offset_ns</code> offset of the camera in time, should be normally 0</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-cpp codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Correct camera time offset</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">      curr_frame</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">t_ns </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> calib</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cam_time_offset_ns</span><span class="token punctuation" style="color:#393A34">;</span></div></div></div></div></div></li></ul><p>After initialisation, the actual processing will only start with two concecutive frames (when both <code>prev_frame</code> and <code>curr_frame</code> are defined):</p><ul><li>Pre-integration is performed, between the two frames, using the latest bias estimation. Blocking may happen, as it reads IMU buffer all the way until one pass the current frame&#x27;s timestamp (<code>while (data-&gt;t_ns &lt;= curr_frame-&gt;t_ns)</code>)<ul><li>Note: the integration will ensure the upper integral timestamp is at least the current frame timestamp (it will make fake IMU measurement by shifting the last IMU readings, when needed)</li></ul></li><li>At the same time, bias correction <code>getCalibrated()</code> are also done for both gyro and accelerometer</li><li>The bulk of the calculation is doen within the <code>measure(curr_frame, meas)</code> function, which is discussed next</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="the-measure-routine"></a>The <code>Measure()</code> Routine<a aria-hidden="true" tabindex="-1" class="hash-link" href="#the-measure-routine" title="Direct link to heading">#</a></h2><p>The <code>measure()</code> routine takes in the current frame optical flow observations, as well as the IMU pre-integration results.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="imu-measurements-processing"></a>IMU measurements Processing<a aria-hidden="true" tabindex="-1" class="hash-link" href="#imu-measurements-processing" title="Direct link to heading">#</a></h3><ul><li><code>frame_states</code> is updated with a entry key <code>last_state_t_ns</code> (current frame timestamp), to be stored with the IMU predicted state</li><li><code>imu_meas</code> is also updated by indexed by the previous frame&#x27;s timestamp</li><li>This whole step might be skipped if IMU measurement is not passed in</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="optical-flow-results-processing"></a>Optical Flow Results Processing<a aria-hidden="true" tabindex="-1" class="hash-link" href="#optical-flow-results-processing" title="Direct link to heading">#</a></h3><p>Pre-processing:</p><ul><li><p><code>prev_opt_flow_res</code> stores, with key in timestamp, the optical flow measurement struct pointer, up to the current time frame</p></li><li><p>For each camera frame, iterate through all observations. If that observed keypoint is already a landmark, add the observation to the landmark database; if not put it to the unconnected observation <strong>set</strong>.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-cpp codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// skeleton</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">size_t i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> opt_flow_meas</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">observations</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">size</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">auto</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> kv_obs </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> opt_flow_meas</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">observations</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lmdb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">landmarkExists</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">kpt_id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">            num_points_connected</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">tcid_host</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">frame_id</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">            unconnected_obs0</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">emplace</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">kpt_id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span></div></div></div></div></div></li></ul><p>Key-framing:</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/chengguizi/chengguizi.github.io/docs/research/vio/basalt-backend.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 40 40" style="margin-right:0.3em;vertical-align:sub"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col text--right"><em><small>Last updated on <time datetime="2020-08-19T09:36:16.000Z" class="docLastUpdatedAt_217_">8/19/2020</time></small></em></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/research/calibration/verify-calibration"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« verify-calibration</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/research/vio/basalt-frontend"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">basalt-frontend »</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_3klQ"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#overview--class-names" class="table-of-contents__link">Overview &amp; Class Names</a></li><li><a href="#io-of-base-class-of-vioestimator" class="table-of-contents__link">I/O of Base Class of VioEstimator</a></li><li><a href="#initialisation" class="table-of-contents__link">Initialisation</a></li><li><a href="#the-processing-thread-within-keypointvioestimator" class="table-of-contents__link">The Processing Thread (within <code>KeypointVioEstimator</code>)</a></li><li><a href="#the-measure-routine" class="table-of-contents__link">The <code>Measure()</code> Routine</a><ul><li><a href="#imu-measurements-processing" class="table-of-contents__link">IMU measurements Processing</a></li><li><a href="#optical-flow-results-processing" class="table-of-contents__link">Optical Flow Results Processing</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/doc1">Style Guide</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/doc2">Second Doc</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow</a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord</a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="text--center"><div>Copyright © 2020 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/styles.0a4195cd.js"></script>
<script src="/runtime~main.0a9401a8.js"></script>
<script src="/main.cb1cffdb.js"></script>
<script src="/1.2d582883.js"></script>
<script src="/2.2b91fbf4.js"></script>
<script src="/3.88e3f531.js"></script>
<script src="/1be78505.bf6c8ae5.js"></script>
<script src="/85.4ee87964.js"></script>
<script src="/20ac7829.db7920b3.js"></script>
<script src="/17896441.00fe9e28.js"></script>
<script src="/c6753341.3e205817.js"></script>
</body>
</html>